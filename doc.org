;-*- mode: Org; fill-column: 110;-*-
* preparation steps of block content for LLM
*oai-restapi-request-prepare chain* that call `oai-restapi-prepare-content'
1) oai-restapi--collect-chat-messages-at-point
  + oai-block-get-content - string
  + oai-block-tags-replace - string
  + oai-restapi--collect-chat-messages - vector
  + oai-block--collect-chat-messages-from-string
    - oai-block--collect-chat-messages
2) (messages (oai-restapi--modify-vector-content messages 'user #'oai-block-tags-replace))
3) (messages (oai-restapi--modify-vector-content messages 'user #'oai-block-tags--clear-properties))


*oai-prompt.el chain* for `oai-prompt-request-chain' function
1) oai-restapi--collect-chat-messages-at-point - vector
3) oai-restapi-request-llm-retries ->
  - (messages (oai-restapi--modify-vector-content messages 'user #'oai-block-tags-replace))
  - (messages (oai-restapi--modify-vector-content messages 'user #'oai-block-tags--clear-properties))

* Hooks - messages preparation for sending or content reading
cases:
- blend all messages to a one text at `oai-block-get-content' step
- blend messages at `oai-restapi-prepare-content' step
- change something in the “last-user-content”
- format text in all messages one by one

May be implemented at:
| operate at raw text level:        | oai-restapi--collect-chat-messages                              |

| operate at messages vector level: | oai-restapi-prepare-content and oai-restapi-request-llm-retries |

Solution:
- before any - raw text level: as `oai-block-parse-part-hook' in `oai-block--parse-part'
- after all - vector level: as `oai-restapi-after-prepare-messages-hook' in `oai-restapi-request-llm-retries' and in `oai-restapi-prepare-content'
* Hook - HTTP headers before sending
[[file:~/sources/emacs-oai/oai-restapi.el::680::(defun oai-restapi--get-headers (service)]]
* Main path of JSON decoding
For not stream
- `oai-restapi--url-request-on-change-function' ->
- `oai-restapi--get-single-response-text' ->
- `oai-block--insert-single-response' ->
- `insert'

for stream:
- `oai-restapi--url-request-on-change-function' ->
- `oai-block--insert-stream-response' -> may be used for single response.
- `oai-restapi--normalize-response' ->
- `insert'

To read data from JSON there is two ways (json-read) and (json-read-from-string), we specify plist as target,
 so we use (plist-get data 'choices) instead of (alist-get 'choices data).
* Tests: Not covered staff
- font-locks
- fill paragraph
